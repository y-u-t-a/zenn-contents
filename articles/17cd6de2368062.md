---
title: "ECR ã®ã‚¿ã‚°ã‚’ä»˜ã‘æ›¿ãˆã‚‹ãƒãƒ³ã‚ºã‚ªãƒ³"
emoji: "ğŸ·ï¸"
type: "tech"
topics: [ "AWS", "ECR" ]
published: true
---

# ã“ã®è¨˜äº‹ã«ã¤ã„ã¦

ECR ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚¿ã‚°ã‚’ä»˜ã‘æ›¿ãˆã‚‹æ–¹æ³•ã®è¨˜äº‹ã‚’èª­ã‚“ã ãŒã€ã¡ã‚ƒã‚“ã¨ç†è§£ã§ããŸå®Ÿæ„ŸãŒãªã‹ã£ãŸã®ã§ãƒãƒ³ã‚ºã‚ªãƒ³è¨˜äº‹ã‚’ä½œæˆã—ã¦ç†è§£ã‚’æ·±ã‚ã‚ˆã†ã¨è©¦ã¿ãŸã€‚
https://docs.aws.amazon.com/ja_jp/AmazonECR/latest/userguide/image-retag.html

ãƒãƒ³ã‚ºã‚ªãƒ³ã§ã¯ã€ECR ãƒªãƒã‚¸ãƒˆãƒªä½œæˆãƒ»ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ—ãƒƒã‚·ãƒ¥ãƒ»ã‚¿ã‚°ã®ä»˜ã‘æ›¿ãˆãƒ»ãƒªã‚½ãƒ¼ã‚¹ã®å‰Šé™¤ã¾ã§è¡Œã†ã€‚
AWS CLI ã®æ¨©é™ã•ãˆæº€ãŸã—ã¦ã„ã‚Œã°å†ç¾æ€§ã®ã‚ã‚‹æ‰‹é †ã«ãªã‚‹ã‚ˆã†è€ƒæ…®ã—ãŸã®ã§ã€æ°—è»½ã«è©¦ã—ã¦ã„ãŸã ããŸã„ã€‚

:::message
zsh ã§æ‰‹é †ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã™ã‚‹å ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã ã¨ã‚³ãƒ¡ãƒ³ãƒˆã®éƒ¨åˆ†ã§ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã®ã§ã€ã‚³ãƒ¡ãƒ³ãƒˆã‚’æœ‰åŠ¹ã«ã™ã‚‹ã“ã¨( `setopt interactivecomments` )
:::

# ECR ãƒªãƒã‚¸ãƒˆãƒªã‚’ä½œæˆ

```bash
aws ecr create-repository \
  --repository-name sample-greet \
  --image-tag-mutability MUTABLE
```

â€» latest ã‚¿ã‚°ã‚’ä¸Šæ›¸ãã™ã‚‹ã®ã§ `--image-tag-mutability MUTABLE` ã«ã—ã¦ã„ã‚‹

# ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ—ãƒƒã‚·ãƒ¥

## ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’æ§‹æˆã™ã‚‹ Dockerfile ã‚’ä½œæˆã™ã‚‹

```bash
cat << EOF > Dockerfile
FROM alpine:latest
ENTRYPOINT [ "echo", "Hello," ]
EOF
```

## ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹

ä»¥ä¸‹ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã€sample-greet ãƒªãƒã‚¸ãƒˆãƒªã«ã€Œv1.0.0ã€ã¨ã€Œlatestã€ã‚¿ã‚°ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒãƒ—ãƒƒã‚·ãƒ¥ã•ã‚Œã‚‹ã€‚

```bash
region=$(aws configure get region)
acount_id=$(aws sts get-caller-identity --query Account --output text)
ecr_host="$acount_id.dkr.ecr.$region.amazonaws.com"
image_uri="$ecr_host/sample-greet"

# èªè¨¼æƒ…å ±ã‚’å–å¾—
aws ecr get-login-password --region $region | docker login --username AWS --password-stdin $ecr_host

# ã‚¤ãƒ¡ãƒ¼ã‚¸ v1.0.0 ã‚’ãƒ“ãƒ«ãƒ‰&ãƒ—ãƒƒã‚·ãƒ¥
docker build . -t sample-greet
docker tag sample-greet "${image_uri}:v1.0.0"
docker push "${image_uri}:v1.0.0"

# Dockerfile ã‚’ä¿®æ­£ã—ã¦ latest æ‰±ã„ã«ã™ã‚‹
cat << EOF > Dockerfile
FROM alpine:latest
ENTRYPOINT [ "echo", "ã“ã‚“ã«ã¡ã¯ã€" ]
EOF

# ã‚¤ãƒ¡ãƒ¼ã‚¸ latest ã‚’ãƒ“ãƒ«ãƒ‰&ãƒ—ãƒƒã‚·ãƒ¥
docker build . -t sample-greet
docker tag sample-greet "${image_uri}:latest"
docker push "${image_uri}:latest"
```

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã€sample-greet ãƒªãƒã‚¸ãƒˆãƒªã«ãƒ—ãƒƒã‚·ãƒ¥ã—ãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ç¢ºèªã§ãã‚‹ã€‚

```bash
aws ecr list-images \
  --repository-name sample-greet
```


# ã‚¤ãƒ¡ãƒ¼ã‚¸ v1.0.0 ã« latest ã‚¿ã‚°ã‚’ä»˜ã‘ã‚‹

```bash
# ã€Œv1.0.0ã€ã® imageManifest ã‚’å–å¾—
MANIFEST=$(
  aws ecr batch-get-image \
    --repository-name sample-greet \
    --image-ids imageTag=v1.0.0 \
    --output json \
  | jq --raw-output --join-output '.images[0].imageManifest' \
)
# ã€Œv1.0.0ã€ã« latest ã‚¿ã‚°ã‚’ä»˜ä¸ã™ã‚‹
aws ecr put-image \
  --repository-name sample-greet \
  --image-tag latest \
  --image-manifest "$MANIFEST"
```

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã€ã€Œv1.0.0ã€ã¨ã€Œlatestã€ã® imageDigest ãŒåŒä¸€ã«ãªã£ãŸã“ã¨ãŒç¢ºèªã§ãã‚‹ã€‚

```bash
aws ecr list-images \
  --repository-name sample-greet
```


# å¾Œç‰‡ä»˜ã‘

```bash
# ãƒªãƒã‚¸ãƒˆãƒªå‰Šé™¤ï¼ˆ `--force` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«ã‚ˆã£ã¦ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚‚ã¾ã¨ã‚ã¦å‰Šé™¤ï¼‰
aws ecr delete-repository \
  --repository-name sample-greet \
  --force

# ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
rm Dockerfile
```

ä»¥ä¸Šã€‚

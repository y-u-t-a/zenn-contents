---
title: "AWS CLI で IAM ロールを作成する"
emoji: "🔧"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["AWS", "IAM"]
published: false
---

# 概要

IAM ロール作成は「空の IAM ロールの作成」「作成した IAM ロールに許可ポリシーをアタッチ」の 2ステップで行う。


# IAM ロールを作成

IAM ロールを作成する際には、ロールの名前とロールを引き受ける対象を指定する。

```bash
aws iam create-role \
  --role-name sample-role \
  --assume-role-policy-document \
'{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "Service": "lambda.amazonaws.com"
            },
            "Action": "sts:AssumeRole"
        }
    ]
}'
```


# 作成した IAM ロールにポリシーをアタッチ


## 作成済みのポリシーまたは AWS管理ポリシーをアタッチ

```bash
aws iam attach-role-policy \
  --role-name sample-role \
  --policy-arn arn:aws:iam::aws:policy/AmazonS3FullAccess
```


## ポリシーを作成する場合

```bash
aws iam create-policy \
  --policy-name sample-policy \
  --policy-document \
'{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": "s3:ListBucket",
            "Resource": "arn:aws:s3:::sample_bucket"
        }
    ]
}'
```

```bash
aws iam attach-role-policy \
  --role-name sample-role \
  --policy-arn <作成したポリシーの ARN>
```

# 後片付け

```bash
# ポリシーを全てデタッチしないと IAM ロールを削除できない
# IAM ロールにアタッチされたポリシーの ARN を取得しデタッチする
attached_policy=$( \
  aws iam list-attached-role-policies \
    --role-name sample-role \
    --query 'AttachedPolicies[*].PolicyArn' \
    --output text \
)
for policy in $attached_policy
do
  aws iam detach-role-policy \
    --role-name sample-role \
    --policy-arn $policy
done

aws iam delete-role --role-name sample-role

aws iam delete-policy --policy-arn <作成したポリシーの ARN>
```

# 参考ページ

- AWS のサービスにアクセス許可を委任するロールの作成
    - https://docs.aws.amazon.com/ja_jp/IAM/latest/UserGuide/id_roles_create_for-service.html
- AWS JSON ポリシーの要素: Principal
    - https://docs.aws.amazon.com/ja_jp/IAM/latest/UserGuide/reference_policies_elements_principal.html
- AWS CLI のリファレンス
    - `aws iam create-role`
        - https://docs.aws.amazon.com/cli/latest/reference/iam/create-role.html
    - `aws iam attach-role-policy`
        - https://docs.aws.amazon.com/cli/latest/reference/iam/attach-role-policy.html
    - `aws iam create-policy`
        - https://docs.aws.amazon.com/cli/latest/reference/iam/create-policy.html
    - `aws iam list-attached-role-policies`
        - https://docs.aws.amazon.com/cli/latest/reference/iam/list-attached-role-policies.html
    - `aws iam detach-role-policy`
        - https://docs.aws.amazon.com/cli/latest/reference/iam/detach-role-policy.html
    - `aws iam delete-role`
        - https://docs.aws.amazon.com/cli/latest/reference/iam/delete-role.html
    - `aws iam delete-policy`
        - https://docs.aws.amazon.com/cli/latest/reference/iam/delete-policy.html

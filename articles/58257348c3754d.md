---
title: "AWS CLI ã§ IAM ãƒ­ãƒ¼ãƒ«ã‚’ä½œæˆã™ã‚‹"
emoji: "ğŸ”§"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["AWS", "IAM"]
published: true
---

# æ¦‚è¦

IAM ãƒ­ãƒ¼ãƒ«ã®ä½œæˆã¯ã€ŒIAM ãƒ­ãƒ¼ãƒ«ã®ä½œæˆã€ã€ŒIAM ãƒ­ãƒ¼ãƒ«ã«ãƒãƒªã‚·ãƒ¼ã‚’ã‚¢ã‚¿ãƒƒãƒã€ã® 2ã‚¹ãƒ†ãƒƒãƒ—ã§è¡Œã†ã€‚
IAM ãƒ­ãƒ¼ãƒ«ã‚’ä½œæˆ â†’ å‰Šé™¤ ã¾ã§ã®æµã‚Œã‚’å®Ÿéš›ã«è¡Œãˆã‚‹ã‚³ãƒãƒ³ãƒ‰ã‚’è¨˜è¼‰ã—ãŸã€‚

# IAM ãƒ­ãƒ¼ãƒ«ã‚’ä½œæˆ

IAM ãƒ­ãƒ¼ãƒ«ã‚’ä½œæˆã™ã‚‹éš›ã«ã¯ã€Œãƒ­ãƒ¼ãƒ«ã®åå‰ã€ã¨ã€Œãƒ­ãƒ¼ãƒ«ã‚’å¼•ãå—ã‘ã‚‹å¯¾è±¡ã€ã‚’æŒ‡å®šã™ã‚‹ã€‚
ã€Œãƒ­ãƒ¼ãƒ«ã‚’å¼•ãå—ã‘ã‚‹å¯¾è±¡ã€ã¯ã€IAM ãƒãƒªã‚·ãƒ¼ã¨åŒæ§˜ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§æŒ‡å®šã™ã‚‹ã€‚

ä»Šå›ã¯ã€ã€Œsample-roleã€ã¨ã„ã†åå‰ã§ã€ã€ŒAWS Lambdaã€ã§ä½¿ç”¨ã§ãã‚‹ãƒ­ãƒ¼ãƒ«ã‚’ä½œæˆã™ã‚‹ã€‚
ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã€IAM ãƒ­ãƒ¼ãƒ«ãŒä½œæˆã•ã‚Œã‚‹ã€‚

```bash
aws iam create-role \
  --role-name sample-role \
  --assume-role-policy-document \
'{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "Service": "lambda.amazonaws.com"
            },
            "Action": "sts:AssumeRole"
        }
    ]
}'
```

ä½œæˆã—ãŸ IAM ãƒ­ãƒ¼ãƒ«ã¯ã€Lambda ã®ç”»é¢ã§ã¯é¸æŠã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ãŒã€ä»–ã®ã‚µãƒ¼ãƒ“ã‚¹ã®ç”»é¢ã§ã¯é¸æŠã§ããªã„ã“ã¨ãŒç¢ºèªã§ãã‚‹ã€‚


# IAM ãƒ­ãƒ¼ãƒ«ã«ãƒãƒªã‚·ãƒ¼ã‚’ã‚¢ã‚¿ãƒƒãƒ

ä½œæˆã—ãŸãƒ­ãƒ¼ãƒ«ã«ã¯ã€ã¾ã ä½•ã‚‚ãƒãƒªã‚·ãƒ¼ãŒã‚¢ã‚¿ãƒƒãƒã•ã‚Œã¦ã„ãªã„ãŸã‚ãƒãƒªã‚·ãƒ¼ã‚’ã‚¢ã‚¿ãƒƒãƒã™ã‚‹ã€‚

## æ—¢å­˜ãƒãƒªã‚·ãƒ¼ã‚’ã‚¢ã‚¿ãƒƒãƒã™ã‚‹å ´åˆ

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã€ä½œæˆã—ãŸãƒ­ãƒ¼ãƒ«ã« AWSç®¡ç†ãƒãƒªã‚·ãƒ¼ã€ŒAmazonS3FullAccessã€ãŒã‚¢ã‚¿ãƒƒãƒã•ã‚Œã‚‹ã€‚

```bash
aws iam attach-role-policy \
  --role-name sample-role \
  --policy-arn arn:aws:iam::aws:policy/AmazonS3FullAccess
```

## ãƒãƒªã‚·ãƒ¼ã‚’ä½œæˆã™ã‚‹å ´åˆ

è¦ä»¶ã‚’æº€ãŸã™ãƒãƒªã‚·ãƒ¼ãŒãªã„å ´åˆã¯ã€ãƒãƒªã‚·ãƒ¼ã‚’ä½œæˆã—ã¦ãƒ­ãƒ¼ãƒ«ã«ã‚¢ã‚¿ãƒƒãƒã™ã‚‹ã€‚
ãƒãƒªã‚·ãƒ¼ã‚’ä½œæˆã™ã‚‹é¸æŠè‚¢ã¯ã€Œã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ãƒãƒªã‚·ãƒ¼ã€ã¨ã€Œã‚«ã‚¹ã‚¿ãƒãƒ¼ç®¡ç†ãƒãƒªã‚·ãƒ¼ã€ã® 2æŠã€‚

### ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ãƒãƒªã‚·ãƒ¼

ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ãƒãƒªã‚·ãƒ¼ã¯ã€å¯¾è±¡ã®ãƒ­ãƒ¼ãƒ«ã§ã®ã¿ä½¿ç”¨ã§ãã‚‹ãƒãƒªã‚·ãƒ¼ã€‚
ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ãƒãƒªã‚·ãƒ¼ã®å ´åˆã¯ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ 1ã¤ã§ãƒãƒªã‚·ãƒ¼ã®ä½œæˆï¼ˆã¾ãŸã¯æ›´æ–°ï¼‰ãƒ»ã‚¢ã‚¿ãƒƒãƒãŒè¡Œã‚ã‚Œã‚‹ã€‚

```bash
aws iam put-role-policy \
  --role-name sample-role \
  --policy-name sample-inline-policy \
  --policy-document \
'{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": "s3:ListBucket",
            "Resource": "arn:aws:s3:::sample_bucket"
        }
    ]
}'
```

### ã‚«ã‚¹ã‚¿ãƒãƒ¼ç®¡ç†ãƒãƒªã‚·ãƒ¼

ã‚«ã‚¹ã‚¿ãƒãƒ¼ç®¡ç†ãƒãƒªã‚·ãƒ¼ã¯ã€è¤‡æ•°ã®ãƒ­ãƒ¼ãƒ«ã§ä½¿ã„å›ã™ã“ã¨ãŒã§ãã‚‹ãƒãƒªã‚·ãƒ¼ã€‚
ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã€ã€ŒS3 ãƒã‚±ãƒƒãƒˆ sample_bucketã€ã«ã€ŒListBucket æ¨©é™ã€ã‚’ã€Œè¨±å¯ã€ã™ã‚‹ã€Œsample-policyã€ã¨ã„ã†åå‰ã®ãƒãƒªã‚·ãƒ¼ãŒä½œæˆã•ã‚Œã‚‹ã€‚
â€» sample_bucket ã¨ã„ã†ãƒªã‚½ãƒ¼ã‚¹ãŒå­˜åœ¨ã—ãªãã¦ã‚‚ãƒãƒªã‚·ãƒ¼ã¯ä½œæˆã§ãã‚‹

```bash
aws iam create-policy \
  --policy-name sample-policy \
  --policy-document \
'{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": "s3:ListBucket",
            "Resource": "arn:aws:s3:::sample_bucket"
        }
    ]
}'
```

AWSç®¡ç†ãƒãƒªã‚·ãƒ¼ã‚’ã‚¢ã‚¿ãƒƒãƒã—ãŸã¨ãã¨åŒæ§˜ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒ­ãƒ¼ãƒ«ã«ãƒãƒªã‚·ãƒ¼ã‚’ã‚¢ã‚¿ãƒƒãƒã™ã‚‹ã€‚

```bash
aws iam attach-role-policy \
  --role-name sample-role \
  --policy-arn <ä½œæˆã—ãŸãƒãƒªã‚·ãƒ¼ã® ARN>
```

# å¾Œç‰‡ä»˜ã‘

ãƒãƒªã‚·ãƒ¼ã‚’å…¨ã¦ãƒ‡ã‚¿ãƒƒãƒã—ãªã„ã¨ IAM ãƒ­ãƒ¼ãƒ«ã‚’å‰Šé™¤ã§ããªã„ãŸã‚ã€IAM ãƒ­ãƒ¼ãƒ«ã«ã‚¢ã‚¿ãƒƒãƒã•ã‚ŒãŸãƒãƒªã‚·ãƒ¼ã‚’å…¨ã¦ãƒ‡ã‚¿ãƒƒãƒã™ã‚‹ã€‚

```bash
# ç®¡ç†ãƒãƒªã‚·ãƒ¼ã®ãƒ‡ã‚¿ãƒƒãƒ
attached_policy_arn=$(
  aws iam list-attached-role-policies \
    --role-name sample-role \
    --query 'AttachedPolicies[*].PolicyArn' \
    --output text \
)
for policy_arn in $attached_policy_arn
do
  aws iam detach-role-policy \
    --role-name sample-role \
    --policy-arn $policy_arn
done

# ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ãƒãƒªã‚·ãƒ¼ã®ãƒ‡ã‚¿ãƒƒãƒ
attached_inleine_policy=$(
  aws iam list-role-policies \
    --role-name sample-role \
    --query 'PolicyNames[*]' \
    --output text \
)
for inleine_policy in $attached_inleine_policy
do
  aws iam delete-role-policy \
    --role-name sample-role \
    --policy-name $inleine_policy
done
```

IAM ãƒ­ãƒ¼ãƒ«ã‚’å‰Šé™¤ã™ã‚‹ã€‚

```bash
aws iam delete-role --role-name sample-role
```

IAM ãƒãƒªã‚·ãƒ¼ã‚’å‰Šé™¤ã™ã‚‹ã€‚

```bash
aws iam delete-policy --policy-arn <ä½œæˆã—ãŸãƒãƒªã‚·ãƒ¼ã® ARN>
```

# ã€è¿½è¨˜ã€‘EC2 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”¨ã® IAM ãƒ­ãƒ¼ãƒ«ã‚’ä½œæˆã™ã‚‹éš›ã®æ³¨æ„ç‚¹

è¨˜äº‹ã«æ›¸ã„ãŸæ‰‹é †ã§ EC2 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”¨ã® IAM ãƒ­ãƒ¼ãƒ«ã‚’ä½œæˆã—ãŸãŒã€EC2 ã® IAM ãƒ­ãƒ¼ãƒ«ã®ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã«è¡¨ç¤ºã•ã‚Œãšå‰²ã‚Šå½“ã¦ã‚‹ã“ã¨ãŒã§ããªã‹ã£ãŸã€‚

èª¿ã¹ãŸã¨ã“ã‚ã€EC2 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ä½¿ç”¨ã™ã‚‹ IAM ãƒ­ãƒ¼ãƒ«ã¨ **ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«** ã‚’ç´ä»˜ã‘ã‚‹å¿…è¦ãŒã‚ã‚‹ã“ã¨ãŒåˆ¤æ˜ã—ãŸã€‚
ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ãƒ­ãƒ¼ãƒ«ã‚’ä½œæˆã™ã‚‹å ´åˆã«ã¯ã€ãƒ­ãƒ¼ãƒ«ã¨ä¸€ç·’ã«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã¦ãƒ­ãƒ¼ãƒ«ã«ç´ä»˜ã‘ã‚‰ã‚Œã‚‹ã€‚
å‚è€ƒ: https://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/iam-roles-for-amazon-ec2.html#ec2-instance-profile

ä»¥ä¸‹ã«ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç´ä»˜ã‘ã‚‹ã‚³ãƒãƒ³ãƒ‰ã‚’ç¤ºã™ã€‚
â€» ec2-role ã¨ã„ã† IAM ãƒ­ãƒ¼ãƒ«ã«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¨­å®šã™ã‚‹æƒ³å®šã®æ‰‹é †

ã¾ãšã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹ã€‚

```bash
aws iam create-instance-profile --instance-profile-name ec2-role
# ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®åå‰ã¯ã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ä½œæˆã—ãŸã¨ãã«åˆã‚ã›ã¦ã€
# å¯¾è±¡ã® IAM ãƒ­ãƒ¼ãƒ«ã¨åŒã˜åå‰ã«ã™ã‚‹
```

ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã¨ IAM ãƒ­ãƒ¼ãƒ«ã‚’ç´ä»˜ã‘ã‚‹ã€‚

```bash
aws iam add-role-to-instance-profile \
  --instance-profile-name ec2-role \
  --role-name ec2-role
```

ã“ã‚Œã§ EC2 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ä½¿ç”¨ã§ãã‚‹ãƒ­ãƒ¼ãƒ«ã«ãªã‚‹ã€‚


# å‚è€ƒãƒšãƒ¼ã‚¸

- AWS ã®ã‚µãƒ¼ãƒ“ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã‚’å§”ä»»ã™ã‚‹ãƒ­ãƒ¼ãƒ«ã®ä½œæˆ
    - https://docs.aws.amazon.com/ja_jp/IAM/latest/UserGuide/id_roles_create_for-service.html
- AWS JSON ãƒãƒªã‚·ãƒ¼ã®è¦ç´ : Principal
    - https://docs.aws.amazon.com/ja_jp/IAM/latest/UserGuide/reference_policies_elements_principal.html
- ç®¡ç†ãƒãƒªã‚·ãƒ¼ã¨ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ãƒãƒªã‚·ãƒ¼
    - https://docs.aws.amazon.com/ja_jp/IAM/latest/UserGuide/access_policies_managed-vs-inline.html
- AWS CLI ã®ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹
    - `aws iam create-role`
        - https://docs.aws.amazon.com/cli/latest/reference/iam/create-role.html
    - `aws iam attach-role-policy`
        - https://docs.aws.amazon.com/cli/latest/reference/iam/attach-role-policy.html
    - `aws iam create-policy`
        - https://docs.aws.amazon.com/cli/latest/reference/iam/create-policy.html
    - `aws iam list-attached-role-policies`
        - https://docs.aws.amazon.com/cli/latest/reference/iam/list-attached-role-policies.html
    - `aws iam detach-role-policy`
        - https://docs.aws.amazon.com/cli/latest/reference/iam/detach-role-policy.html
    - `aws iam delete-role`
        - https://docs.aws.amazon.com/cli/latest/reference/iam/delete-role.html
    - `aws iam delete-policy`
        - https://docs.aws.amazon.com/cli/latest/reference/iam/delete-policy.html

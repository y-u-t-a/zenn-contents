---
title: "AWS CLI ã§ IAM ãƒ­ãƒ¼ãƒ«ã‚’ä½œæˆã™ã‚‹"
emoji: "ğŸ”§"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["AWS", "IAM"]
published: true
---

# æ¦‚è¦

IAM ãƒ­ãƒ¼ãƒ«ã®ä½œæˆã¯ã€Œç©ºã® IAM ãƒ­ãƒ¼ãƒ«ã®ä½œæˆã€ã€Œä½œæˆã—ãŸ IAM ãƒ­ãƒ¼ãƒ«ã«ãƒãƒªã‚·ãƒ¼ã‚’ã‚¢ã‚¿ãƒƒãƒã€ã® 2ã‚¹ãƒ†ãƒƒãƒ—ã§è¡Œã†ã€‚
IAM ãƒ­ãƒ¼ãƒ«ã‚’ä½œæˆ â†’ å‰Šé™¤ ã¾ã§ã®æµã‚Œã‚’å®Ÿéš›ã«è¡Œãˆã‚‹ã‚³ãƒãƒ³ãƒ‰ã‚’è¨˜è¼‰ã—ãŸã€‚

# IAM ãƒ­ãƒ¼ãƒ«ã‚’ä½œæˆ

IAM ãƒ­ãƒ¼ãƒ«ã‚’ä½œæˆã™ã‚‹éš›ã«ã¯ã€Œãƒ­ãƒ¼ãƒ«ã®åå‰ã€ã¨ã€Œãƒ­ãƒ¼ãƒ«ã‚’å¼•ãå—ã‘ã‚‹å¯¾è±¡ã€ã‚’æŒ‡å®šã™ã‚‹ã€‚
ã€Œãƒ­ãƒ¼ãƒ«ã‚’å¼•ãå—ã‘ã‚‹å¯¾è±¡ã€ã¯ã€IAM ãƒãƒªã‚·ãƒ¼ã¨åŒæ§˜ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§æŒ‡å®šã™ã‚‹ã€‚ï¼ˆ `--assume-role-policy-document` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

ä»Šå›ã¯ã€ã€Œsample-roleã€ã¨ã„ã†åå‰ã§ã€ã€ŒAWS Lambdaã€ã§ä½¿ç”¨ã§ãã‚‹ãƒ­ãƒ¼ãƒ«ã‚’ä½œæˆã™ã‚‹ã€‚
ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã€IAM ãƒ­ãƒ¼ãƒ«ãŒä½œæˆã•ã‚Œã‚‹ã€‚

```bash
aws iam create-role \
  --role-name sample-role \
  --assume-role-policy-document \
'{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "Service": "lambda.amazonaws.com"
            },
            "Action": "sts:AssumeRole"
        }
    ]
}'
```

ä½œæˆã—ãŸ IAM ãƒ­ãƒ¼ãƒ«ã¯ã€Lambda ã®ç”»é¢ã§ã¯é¸æŠã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ãŒã€ä»–ã®ã‚µãƒ¼ãƒ“ã‚¹ã®ç”»é¢ã§ã¯é¸æŠã§ããªã„ã“ã¨ãŒç¢ºèªã§ãã‚‹ã€‚


# ä½œæˆã—ãŸ IAM ãƒ­ãƒ¼ãƒ«ã«ãƒãƒªã‚·ãƒ¼ã‚’ã‚¢ã‚¿ãƒƒãƒ

ä½œæˆã—ãŸãƒ­ãƒ¼ãƒ«ã«ã¯ã€ã¾ã ä½•ã‚‚ãƒãƒªã‚·ãƒ¼ãŒã‚¢ã‚¿ãƒƒãƒã•ã‚Œã¦ã„ãªã„ãŸã‚ãƒãƒªã‚·ãƒ¼ã‚’ã‚¢ã‚¿ãƒƒãƒã™ã‚‹ã€‚

## æ—¢å­˜ãƒãƒªã‚·ãƒ¼ã‚’ã‚¢ã‚¿ãƒƒãƒã™ã‚‹å ´åˆ

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã€ä½œæˆã—ãŸãƒ­ãƒ¼ãƒ«ã« AWSç®¡ç†ãƒãƒªã‚·ãƒ¼ã€ŒAmazonS3FullAccessã€ãŒã‚¢ã‚¿ãƒƒãƒã•ã‚Œã‚‹ã€‚

```bash
aws iam attach-role-policy \
  --role-name sample-role \
  --policy-arn arn:aws:iam::aws:policy/AmazonS3FullAccess
```


## ãƒãƒªã‚·ãƒ¼ã‚’ä½œæˆã™ã‚‹å ´åˆ

è¦ä»¶ã‚’æº€ãŸã™ãƒãƒªã‚·ãƒ¼ãŒãªã„å ´åˆã¯ã€ãƒãƒªã‚·ãƒ¼ã‚’ä½œæˆã—ã¦ãƒ­ãƒ¼ãƒ«ã«ã‚¢ã‚¿ãƒƒãƒã™ã‚‹ã€‚

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã€ã€ŒS3 ãƒã‚±ãƒƒãƒˆ sample_bucketã€ã«ã€ŒListBucket æ¨©é™ã€ã‚’ã€Œè¨±å¯ã€ã™ã‚‹ã€Œsample-policyã€ã¨ã„ã†åå‰ã®ãƒãƒªã‚·ãƒ¼ãŒä½œæˆã•ã‚Œã‚‹ã€‚
â€» sample_bucket ã¨ã„ã†ãƒªã‚½ãƒ¼ã‚¹ãŒå­˜åœ¨ã—ãªãã¦ã‚‚ãƒãƒªã‚·ãƒ¼ã¯ä½œæˆã§ãã‚‹

```bash
aws iam create-policy \
  --policy-name sample-policy \
  --policy-document \
'{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": "s3:ListBucket",
            "Resource": "arn:aws:s3:::sample_bucket"
        }
    ]
}'
```

AWSç®¡ç†ãƒãƒªã‚·ãƒ¼ã‚’ã‚¢ã‚¿ãƒƒãƒã—ãŸã¨ãã¨åŒæ§˜ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒ­ãƒ¼ãƒ«ã«ãƒãƒªã‚·ãƒ¼ã‚’ã‚¢ã‚¿ãƒƒãƒã™ã‚‹ã€‚

```bash
aws iam attach-role-policy \
  --role-name sample-role \
  --policy-arn <ä½œæˆã—ãŸãƒãƒªã‚·ãƒ¼ã® ARN>
```

# å¾Œç‰‡ä»˜ã‘

ãƒãƒªã‚·ãƒ¼ã‚’å…¨ã¦ãƒ‡ã‚¿ãƒƒãƒã—ãªã„ã¨ IAM ãƒ­ãƒ¼ãƒ«ã‚’å‰Šé™¤ã§ããªã„ãŸã‚ã€IAM ãƒ­ãƒ¼ãƒ«ã«ã‚¢ã‚¿ãƒƒãƒã•ã‚ŒãŸãƒãƒªã‚·ãƒ¼ã® ARN ã‚’å–å¾—ã—ãƒ‡ã‚¿ãƒƒãƒã™ã‚‹ã€‚

```bash
attached_policy_arn=$( \
  aws iam list-attached-role-policies \
    --role-name sample-role \
    --query 'AttachedPolicies[*].PolicyArn' \
    --output text \
)
for policy_arn in $attached_policy_arn
do
  aws iam detach-role-policy \
    --role-name sample-role \
    --policy-arn $policy_arn
done
```

IAM ãƒ­ãƒ¼ãƒ«ã‚’å‰Šé™¤ã™ã‚‹ã€‚

```bash
aws iam delete-role --role-name sample-role
```

IAM ãƒãƒªã‚·ãƒ¼ã‚’å‰Šé™¤ã™ã‚‹ã€‚

```bash
aws iam delete-policy --policy-arn <ä½œæˆã—ãŸãƒãƒªã‚·ãƒ¼ã® ARN>
```

# å‚è€ƒãƒšãƒ¼ã‚¸

- AWS ã®ã‚µãƒ¼ãƒ“ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã‚’å§”ä»»ã™ã‚‹ãƒ­ãƒ¼ãƒ«ã®ä½œæˆ
    - https://docs.aws.amazon.com/ja_jp/IAM/latest/UserGuide/id_roles_create_for-service.html
- AWS JSON ãƒãƒªã‚·ãƒ¼ã®è¦ç´ : Principal
    - https://docs.aws.amazon.com/ja_jp/IAM/latest/UserGuide/reference_policies_elements_principal.html
- AWS CLI ã®ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹
    - `aws iam create-role`
        - https://docs.aws.amazon.com/cli/latest/reference/iam/create-role.html
    - `aws iam attach-role-policy`
        - https://docs.aws.amazon.com/cli/latest/reference/iam/attach-role-policy.html
    - `aws iam create-policy`
        - https://docs.aws.amazon.com/cli/latest/reference/iam/create-policy.html
    - `aws iam list-attached-role-policies`
        - https://docs.aws.amazon.com/cli/latest/reference/iam/list-attached-role-policies.html
    - `aws iam detach-role-policy`
        - https://docs.aws.amazon.com/cli/latest/reference/iam/detach-role-policy.html
    - `aws iam delete-role`
        - https://docs.aws.amazon.com/cli/latest/reference/iam/delete-role.html
    - `aws iam delete-policy`
        - https://docs.aws.amazon.com/cli/latest/reference/iam/delete-policy.html

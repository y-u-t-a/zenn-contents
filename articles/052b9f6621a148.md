---
title: "æ—¢å­˜ AWS ãƒªã‚½ãƒ¼ã‚¹ã‚’ Terraform åŒ–ã™ã‚‹ãƒãƒ³ã‚ºã‚ªãƒ³"
emoji: "ğŸŸª"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Terraform", "AWS"]
published: true
---

# Terraform åŒ–ã™ã‚‹ãƒªã‚½ãƒ¼ã‚¹ã‚’æ‰‹å‹•ã§ä½œæˆã™ã‚‹

ä»Šå›ã®ä¾‹ã§ã¯ã€example-group ã«æ‰€å±ã™ã‚‹ example-user ã‚’ Terraform åŒ–ã™ã‚‹ã€‚
ã¾ãšã¯ Terraform åŒ–ã™ã‚‹ AWS ãƒªã‚½ãƒ¼ã‚¹ã‚’ AWS CLI ã§ä½œæˆã™ã‚‹ã€‚

```sh
# IAM ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆ
aws iam create-group --group-name example-group

# IAM ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
aws iam create-user --user-name example-user

# IAM ã‚°ãƒ«ãƒ¼ãƒ—ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ 
aws iam add-user-to-group \
  --group-name example-group \
  --user-name example-user
```

# Terraform ãƒªã‚½ãƒ¼ã‚¹ã®ç‰¹å®š

Terraform åŒ–ã™ã‚‹ã«ã‚ãŸã£ã¦ã€æœ€åˆã«å¯¾è±¡ãƒªã‚½ãƒ¼ã‚¹ãŒã©ã® Terraform ãƒªã‚½ãƒ¼ã‚¹ã«ç›¸å½“ã™ã‚‹ã‹ã‚’èª¿ã¹ã‚‹ã€‚
Terraform ã® [AWS Provider ã®ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹](https://registry.terraform.io/providers/hashicorp/aws/latest/docs) ã§ IAM é–¢é€£ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’èª¿ã¹ã¦ç‰¹å®šã™ã‚‹ã€‚

ä»Šå›ã®ä¾‹ã§ã¯ã€ä»¥ä¸‹ã®3ã¤ã® Terraform ãƒªã‚½ãƒ¼ã‚¹ã«ç›¸å½“ã™ã‚‹ã€‚

- [aws_iam_group](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_group)
- [aws_iam_user](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_user)
- [aws_iam_user_group_membership](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_user_group_membership)


:::message
IAM ã‚°ãƒ«ãƒ¼ãƒ—ã®æ‰€å±ã®å®šç¾©ã¯ä»¥ä¸‹ã®2é€šã‚ŠãŒã‚ã‚‹ã€‚

- aws_iam_user_group_membership: **ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ**ã©ã®ã‚°ãƒ«ãƒ¼ãƒ—ã«æ‰€å±ã—ã¦ã„ã‚‹ã‹ã‚’è¡¨ã™
- [aws_iam_group_membership](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_group_membership): **ã‚°ãƒ«ãƒ¼ãƒ—ã«**ã©ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰€å±ã—ã¦ã„ã‚‹ã‹ã‚’è¡¨ã™

ä»Šå›ã®ä¾‹ã§ã¯å‰è€…ã®æ–¹ã‚’åˆ©ç”¨ã™ã‚‹ã€‚
:::

:::message
ä»Šå›ã®ä¾‹ã§ã¯å˜ç´”åŒ–ã™ã‚‹ãŸã‚ã«ãƒãƒªã‚·ãƒ¼ãŒãªã„ãƒªã‚½ãƒ¼ã‚¹ã‚’ Terraform åŒ–ã—ã¦ã„ã‚‹ã€‚
å®Ÿéš›ã«æ—¢å­˜ã® IAM é–¢é€£ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’å³å¯†ã« Terraform åŒ–ã™ã‚‹ã«ã¯ãƒãƒªã‚·ãƒ¼é–¢é€£ã® Terraform åŒ–ã‚‚å¿…è¦ã«ãªã‚‹ã€‚
:::


# Terraform ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®åˆæœŸåŒ–

ä»»æ„ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ Terraform ã®ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¨ã—ã¦æ‰±ã†ã€‚
ä»¥é™ã®æ‰‹é †ã¯ã€Terraform ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§è¡Œã†ã€‚

## .tf ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ

ä½¿ç”¨ã™ã‚‹ Terraform ãƒªã‚½ãƒ¼ã‚¹ã‚’å®šç¾©ã—ãŸ .tf ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹ã€‚
`resource "resource_name" "local_name" {}` ã®å½¢å¼ã§ã€å‰ã®æ‰‹é †ã§èª¿ã¹ãŸãƒªã‚½ãƒ¼ã‚¹ã‚’å®šç¾©ã™ã‚‹ã€‚
ã¾ãšã¯ã€main.tf ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¾ã¨ã‚ã¦å®šç¾©ã™ã‚‹ã€‚

```tf:main.tf
resource "aws_iam_group" "example_group" {}

resource "aws_iam_user" "example_user" {}

resource "aws_iam_user_group_membership" "example_user" {}
```

## `terraform init`

ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ãŸã‚‰ `terraform init` ã‚’å®Ÿè¡Œã™ã‚‹ã€‚
ã“ã‚Œã«ã‚ˆã£ã¦ Terraform ã‚’æ‰±ã†ãŸã‚ã«å¿…è¦ãªãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ã€‚


# Terraform åŒ–

ã“ã“ã‹ã‚‰æœ¬é¡Œã® Terraform åŒ–ã‚’è¡Œã£ã¦ã„ãã€‚
æœ¬ãƒãƒ³ã‚ºã‚ªãƒ³ã§ã¯ã€Terraform CLI ã‚’ç”¨ã„ãŸæ–¹æ³•ã‚’ç´¹ä»‹ã™ã‚‹ã€‚
https://developer.hashicorp.com/terraform/cli/commands/import

## `terraform import`

`terraform import` ã¯ã€å®šç¾©ã—ãŸ Terraform ãƒªã‚½ãƒ¼ã‚¹ã¨æ—¢å­˜ãƒªã‚½ãƒ¼ã‚¹ã‚’çµã³ã¤ã‘ã¦ã€ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã® tfstate ã«åæ˜ ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã§ã‚ã‚‹ã€‚

ã‚³ãƒãƒ³ãƒ‰ã¯ `terraform import [options] ADDRESS ID` ã®å½¢å¼ã§å®Ÿè¡Œã™ã‚‹ã€‚
`ADDRESS` ã¯ã€.tf ãƒ•ã‚¡ã‚¤ãƒ«ã«è¨˜è¿°ã—ãŸãƒªã‚½ãƒ¼ã‚¹ã‚’ç‰¹å®šã™ã‚‹ã‚‚ã®ã§ã€ `resource_name.local_name` ã®å½¢å¼ã§è¡¨ã•ã‚Œã‚‹ã€‚
`ID` ã¯ã€import ã™ã‚‹æ—¢å­˜ãƒªã‚½ãƒ¼ã‚¹ã‚’ç‰¹å®šã™ã‚‹ã‚‚ã®ã§ã€å½¢å¼ã¯ Terraform ãƒªã‚½ãƒ¼ã‚¹ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã® Import ç¯€ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã€‚

ä»Šå›ã®å ´åˆã¯ã€ä»¥ä¸‹ã®3ã¤ã®ã‚³ãƒãƒ³ãƒ‰ã§ import ã™ã‚‹ã€‚

```sh
terraform import aws_iam_group.example_group example-group

terraform import aws_iam_user.example_user example-user

terraform import aws_iam_user_group_membership.example_user example-user/example-group
```

ã“ã‚Œã«ã‚ˆã‚Šã€Terraform ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ç¾åœ¨ã® tfstate ãŒã€æ—¢å­˜ãƒªã‚½ãƒ¼ã‚¹ã‚’è¡¨ã—ãŸ tfstate ã«ãªã‚‹ã€‚


## `terraform plan` ã§å·®åˆ†ãŒãªã„çŠ¶æ…‹ã«ã™ã‚‹

Terraform åŒ–ã§ããŸçŠ¶æ…‹ã¨ã¯ã€ã€Œ.tf ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ç”Ÿæˆã•ã‚Œã‚‹ tfstateã€ã¨ã€Œæ—¢å­˜ãƒªã‚½ãƒ¼ã‚¹ã‚’è¡¨ã—ãŸç¾åœ¨ã® tfstateã€ãŒä¸€è‡´ã—ãŸçŠ¶æ…‹ã§ã‚ã‚‹ã€‚
ç¾çŠ¶ã€.tf ãƒ•ã‚¡ã‚¤ãƒ«ã«å®šç¾©ã—ãŸ resource ã¯ç©ºã£ã½ã§ã‚ã‚‹ãŸã‚ã€Œç¾åœ¨ã® tfstateã€ã¨ã¯ä¹–é›¢ã—ãŸçŠ¶æ…‹ã§ã‚ã‚‹ã€‚

`terraform plan` ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€Œ.tf ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ç”Ÿæˆã•ã‚Œã‚‹ tfstateã€ã¨ã€Œç¾åœ¨ã® tfstateã€ã¨ã®å·®åˆ†ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã€‚
ã€Œç¾åœ¨ã® tfstateã€ã¯æ—¢å­˜ãƒªã‚½ãƒ¼ã‚¹ã¨ä¸€è‡´ã—ã¦ã„ã‚‹ãŸã‚ã€`terraform plan` ã‚³ãƒãƒ³ãƒ‰ã§å·®åˆ†ãŒãªããªã‚Œã° .tf ãƒ•ã‚¡ã‚¤ãƒ«ã§æ—¢å­˜ãƒªã‚½ãƒ¼ã‚¹ã‚’è¡¨ç¾ã§ãã¦ã„ã‚‹ã“ã¨ï¼ˆ= Terraform åŒ–ã§ããŸçŠ¶æ…‹ï¼‰ã«ãªã‚‹ã€‚

ç¾æ™‚ç‚¹ã§ `terraform plan` ã‚’å®Ÿè¡Œã™ã‚‹ã¨ resource ã«å¿…é ˆé …ç›®ãŒãªã„ãŸã‚ã«ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã€‚
tfstate ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‚ç…§ã—ãªãŒã‚‰ resource ã® name ãªã©ã®é …ç›®ã‚’åŸ‹ã‚ã¦ã„ãã€‚
æœ€çµ‚çš„ã« `terraform plan` ã®å®Ÿè¡ŒçµæœãŒ "No changes." ã«ãªã‚Œã° Terraform åŒ–ã¯å®Œäº†ã¨ãªã‚‹ã€‚


## Terraform ã‹ã‚‰ãƒªã‚½ãƒ¼ã‚¹ã«å¤‰æ›´ã‚’åŠ ãˆã‚‹

Terraform åŒ–ã§ããŸã“ã¨ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã«ã€Terraform ã‹ã‚‰ãƒªã‚½ãƒ¼ã‚¹ã«å¤‰æ›´ã‚’åŠ ãˆã¦ã¿ã‚‹ã€‚
è©¦ã—ã« IAM ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒªã‚½ãƒ¼ã‚¹ã‚¿ã‚°ã‚’è¿½åŠ ã™ã‚‹ã€‚
ä»¥ä¸‹ã®ã‚ˆã†ã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒªã‚½ãƒ¼ã‚¹ã« tags ã‚’è¿½è¨˜ã™ã‚‹ã€‚

```diff:main.tf
...
resource "aws_iam_user" "example_user" {
  name = "example-user"
+ tags = {
+   "key": "value",
+   "key2": "value2",
+ }
}
...
```

`terraform plan` ã™ã‚‹ã¨ã€è¿½è¨˜ã—ãŸ tags ãŒå·®åˆ†ã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã‚‹ã€‚
`terraform apply` ã™ã‚‹ã¨å¤‰æ›´ãŒé©ç”¨ã•ã‚Œã‚‹ã€‚


# ã„ã‚ã„ã‚å¤‰æ›´ã—ã¦ã¿ã‚‹

ä»¥ä¸‹ã®ã‚ˆã†ãªå¤‰æ›´ã‚’åŠ ãˆã‚‹ã¨ Terraform ã®ã‚­ãƒ£ãƒƒãƒã‚¢ãƒƒãƒ—ã«ã¡ã‚‡ã†ã©ã„ã„ã¨æ€ã‚ã‚Œã‚‹ã€‚

- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ ã—ã¦ã¿ã‚‹
- .tf ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†å‰²ã—ã¦ã¿ã‚‹
- IAM ã‚°ãƒ«ãƒ¼ãƒ—ã«ãƒãƒªã‚·ãƒ¼ã‚’è¿½åŠ ã—ã¦ã¿ã‚‹


# ãƒªã‚½ãƒ¼ã‚¹ã®å‰Šé™¤

ä¸€é€šã‚ŠéŠã‚“ã ã‚‰ãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤ã™ã‚‹ã€‚
Terraform åŒ–ã§ãã¦ã„ã‚‹ã®ã§ã€`terraform destroy` ã§å‰Šé™¤ã§ãã‚‹ã€‚
ä¸€å¿œã€tfstate ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¦‹ã¦ã©ã®ãƒªã‚½ãƒ¼ã‚¹ãŒå¯¾è±¡ã«ãªã£ã¦ã„ã‚‹ã‹ç¢ºèªã—ãŸä¸Šã§å®Ÿè¡Œã™ã‚‹ã“ã¨ã€‚
